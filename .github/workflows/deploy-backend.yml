name: Deploy Backend

on:
  push:
    branches:
      - prod
    paths:
      - 'SourceCode/back-end/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Backend
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            download-buffer-size = 512000000

      - name: Use Cachix Cache ðŸ“¦
        uses: cachix/cachix-action@v16
        with:
          name: logsmart-cache
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          extraPullNames: nixpkgs, nix-community, arm, rust

      - name: Build for ARM64
        working-directory: ./SourceCode/back-end
        run: |
          nix build .#aarch64-linux
          ls -la result/bin
          cp result/bin/logsmart-srv ./logsmart-srv

      - name: Stop service before deployment
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            sudo systemctl stop logsmart.service

      - name: Deploy to Server
        uses: wlixcc/SFTP-Deploy-Action@v1.2.6
        with:
          server: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          ssh_private_key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          local_path: "SourceCode/back-end/logsmart-srv"
          remote_path: "${{ vars.DEPLOY_PATH }}/"

      - name: Patch interpreter path
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            patchelf --set-interpreter /lib/ld-linux-aarch64.so.1 ${{ vars.DEPLOY_PATH }}/logsmart-srv

      - name: Start Service
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            chmod +x ${{ vars.DEPLOY_PATH }}/logsmart-srv
            sudo systemctl start logsmart.service