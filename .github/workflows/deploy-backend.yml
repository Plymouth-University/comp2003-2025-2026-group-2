name: Deploy Backend

on:
  push:
    branches:
      - prod
    paths:
      - 'SourceCode/back-end/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build Docker Image and Deploy
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            download-buffer-size = 512000000

      - name: Use Cachix Cache ðŸ“¦
        uses: cachix/cachix-action@v16
        with:
          name: logsmart-cache
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          extraPullNames: nixpkgs, nix-community, arm, rust

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        working-directory: ./SourceCode/back-end
        run: |
          echo "ðŸ”¨ Building Docker Image from Nix..."
          # Builds the image defined in flake.nix (which cross-compiles to ARM64)
          nix build .#docker-image
          
          echo "ðŸ“¥ Loading Image into Docker..."
          # 'result' is a tarball containing the image. We load it into the runner's Docker.
          docker load < result
          
          echo "JX Retagging and Pushing..."
          # The nix build creates an image named 'logsmart-backend:latest' (from flake.nix)
          # We retag it to your Docker Hub repo
          docker tag logsmart-backend:latest nullstring1/logsmart-srv:latest
          
          # Push to Docker Hub
          docker push nullstring1/logsmart-srv:latest

      - name: Deploy to Swarm
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            # 1. Pull the new image explicitly
            docker pull nullstring1/logsmart-srv:latest
            
            # 2. Update the service in the swarm
            # Note: 'logsmart_stack' is the stack name, 'backend' is the service name in compose
            docker service update --image nullstring1/logsmart-srv:latest logsmart_stack_backend --with-registry-auth