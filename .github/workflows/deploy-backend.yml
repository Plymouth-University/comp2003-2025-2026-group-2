name: Deploy Backend

on:
  push:
    branches:
      - prod
    paths:
      - 'SourceCode/back-end/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build Docker Image and Deploy
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            download-buffer-size = 512000000

      - name: Use Cachix Cache ðŸ“¦
        uses: cachix/cachix-action@v16
        with:
          name: logsmart-cache
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          extraPullNames: nixpkgs, nix-community, arm, rust

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Check if image already exists
        id: check-image
        run: |
          TAG=${GITHUB_SHA::8}
          IMAGE_NAME="nullstring1/logsmart-srv"
          # Check for manifest on Docker Hub
          if docker manifest inspect $IMAGE_NAME:${TAG}-aarch64 > /dev/null 2>&1; then
            echo "âœ… Image ${TAG}-aarch64 already exists. Skipping build."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Image not found. Proceeding with build."
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build and Push Docker Image
        if: steps.check-image.outputs.exists == 'false'
        working-directory: ./SourceCode/back-end
        run: |
          TAG=${GITHUB_SHA::8}
          echo "ðŸ”¨ Building Docker Image from Nix..."
          nix build .#docker-image-aarch64
          
          echo "ðŸ“¥ Loading and Tagging Image..."
          docker load < result
          docker tag nullstring1/logsmart-srv:latest-aarch64 nullstring1/logsmart-srv:${TAG}-aarch64

          echo "ðŸ“¤ Pushing..."
          docker push nullstring1/logsmart-srv:latest-aarch64
          docker push nullstring1/logsmart-srv:${TAG}-aarch64

      - name: Deploy to Swarm
        uses: appleboy/ssh-action@v1.2.5
        env:
          GITHUB_SHA: ${{ github.sha }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          envs: 
            GITHUB_SHA
          script: |
            TAG=${GITHUB_SHA:0:8}
            # 1. Pull the new image explicitly
            docker pull nullstring1/logsmart-srv:${TAG}-aarch64
            
            # 2. Update the service in the swarm
            # Note: 'logsmart_stack' is the stack name, 'backend' is the service name in compose
            docker service update --image nullstring1/logsmart-srv:${TAG}-aarch64 logsmart_stack_backend --with-registry-auth