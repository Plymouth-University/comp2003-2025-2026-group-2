services:
  mongodb:
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=rootpassword
      - MONGO_INITDB_ROOT_PASSWORD_FILE=
      - MONGO_INITDB_ROOT_USERNAME_FILE=
    secrets: []
    networks:
      - logsmart-net
  postgres:
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=adminpassword
      - POSTGRES_DB=logsmartdb
      - POSTGRES_PASSWORD_FILE=
      - POSTGRES_USER_FILE=
    secrets: []
    networks:
      - logsmart-net
  mailhog:
    image: mailhog/mailhog:latest
    container_name: mailhog
    networks:
      - logsmart-net
    ports:
      - "1025:1025"
      - "8025:8025"

  mockoidc:
    image: ghcr.io/navikt/mock-oauth2-server:2.1.10
    container_name: mockoidc
    networks:
      - logsmart-net
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - LOG_LEVEL=INFO
      - JSON_CONFIG={"interactiveLogin":true,"httpServer":"NettyWrapper","tokenCallbacks":[{"issuerId":"google","tokenExpiry":3600,"requestMappings":[{"requestParam":"scope","match":".*","claims":{"sub":"mock-google-user-123","email":"testuser@gmail.com","email_verified":true,"given_name":"Test","family_name":"User","picture":"https://example.com/avatar.jpg"}}]}]}
  backend:
    networks:
      - logsmart-net
    image: rust:latest
    volumes:
      - .:/app
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/app/target
    working_dir: /app
    command: >
      cargo run
    ports:
      - "6767:6767"
    environment:
      - JWT_SECRET=jwt_secret_dev
      - POSTGRES_HOST=postgres
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=adminpassword
      - MONGODB_URI=mongodb://root:rootpassword@mongodb:27017
      - DATABASE_URL=postgres://admin:adminpassword@postgres:5432/logsmartdb
      - DISABLE_RATE_LIMIT=1
      - SMTP_SERVER=mailhog:1025
      - SMTP_USERNAME=
      - SMTP_PASSWORD=
      - SMTP_FROM_EMAIL=noreply@logsmart.app
      - SMTP_FROM_NAME="LogSmart Dev"
      - GOOGLE_CLIENT_ID=mock-google-client-id
      - GOOGLE_CLIENT_SECRET=mock-google-client-secret
      - GOOGLE_ISSUER_URL=http://mockoidc:8080/google
      - GOOGLE_REDIRECT_URI=http://localhost:6767/auth/google/callback
      - RP_ID=localhost
      - RP_ORIGIN=http://localhost:5173
      - COOKIE_DOMAIN=localhost
      - FRONTEND_URL=http://localhost:5173
      - POSTGRES_PASSWORD_FILE=
      - POSTGRES_USER_FILE=
      - MONGODB_URI_FILE=
      - JWT_SECRET_FILE=
      - SMTP_USERNAME_FILE=
      - SMTP_PASSWORD_FILE=
      - GOOGLE_CLIENT_ID_FILE=
      - GOOGLE_CLIENT_SECRET_FILE=
    depends_on:
      - mongodb
      - postgres
      - mailhog
      - mockoidc
    secrets: []
    
volumes:
  cargo-cache:
  target-cache:
networks:
  logsmart-net:
    driver: bridge

secrets:
  jwt_secret_v1:
    file: /dev/null
    external: false
  smtp_username_v1:
    file: /dev/null
    external: false
  smtp_password_v1:
    file: /dev/null
    external: false
  google_client_id_v1:
    file: /dev/null
    external: false
  google_client_secret_v1:
    file: /dev/null
    external: false
  mongodb_uri_v3:
    file: /dev/null
    external: false
  mongodb_root_username_v1:
    file: /dev/null
    external: false
  mongodb_root_password_v2:
    file: /dev/null
    external: false
  postgres_user_v1:
    file: /dev/null
    external: false
  postgres_password_v2:
    file: /dev/null
    external: false
